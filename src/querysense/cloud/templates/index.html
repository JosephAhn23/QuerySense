{% extends "base.html" %}
{% block title %}Dashboard — QuerySense Cloud{% endblock %}

{% block content %}
{% if user %}
<!-- Dashboard Header -->
<div class="sm:flex sm:items-center sm:justify-between mb-8">
    <div>
        <h1 class="text-2xl font-bold text-gray-900">Dashboard</h1>
        <p class="mt-1 text-sm text-gray-500">Overview of your query performance and compliance posture.</p>
    </div>
    <div class="mt-4 sm:mt-0 flex gap-3">
        <a href="/plans/upload" class="inline-flex items-center px-4 py-2 bg-brand-600 text-white text-sm font-medium rounded-lg hover:bg-brand-700 shadow-sm">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            Analyze Plan
        </a>
    </div>
</div>

<!-- Health Score + Stats -->
<div class="grid grid-cols-1 lg:grid-cols-5 gap-5 mb-8">
    <!-- Health Score Card -->
    <div class="lg:col-span-1 stat-card bg-gradient-to-br from-brand-600 to-brand-800 text-white border-0">
        <div class="text-center">
            <p class="text-sm font-medium text-brand-100">Health Score</p>
            <div class="mt-2 relative inline-flex items-center justify-center">
                <canvas id="healthScoreChart" width="100" height="100"></canvas>
                <span class="absolute text-2xl font-bold" id="healthScoreLabel">{{ health_score | default(92) }}</span>
            </div>
            <p class="text-xs text-brand-200 mt-2">
                {% if (health_score | default(92)) >= 80 %}Excellent{% elif (health_score | default(92)) >= 60 %}Good{% elif (health_score | default(92)) >= 40 %}Needs Attention{% else %}Critical{% endif %}
            </p>
        </div>
    </div>

    <!-- Stats -->
    <div class="lg:col-span-4 grid grid-cols-2 sm:grid-cols-4 gap-5">
        <div class="stat-card">
            <div class="flex items-center">
                <div class="flex-shrink-0 p-3 rounded-lg bg-brand-50">
                    <svg class="w-6 h-6 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Plans</p>
                    <p class="text-2xl font-bold text-gray-900">{{ stats.total_plans }}</p>
                </div>
            </div>
        </div>

        <div class="stat-card">
            <div class="flex items-center">
                <div class="flex-shrink-0 p-3 rounded-lg bg-yellow-50">
                    <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Findings</p>
                    <p class="text-2xl font-bold text-gray-900">{{ stats.total_findings }}</p>
                </div>
            </div>
        </div>

        <div class="stat-card">
            <div class="flex items-center">
                <div class="flex-shrink-0 p-3 rounded-lg bg-red-50">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Critical</p>
                    <p class="text-2xl font-bold text-red-600">{{ stats.critical }}</p>
                </div>
            </div>
        </div>

        <div class="stat-card">
            <div class="flex items-center">
                <div class="flex-shrink-0 p-3 rounded-lg bg-green-50">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Compliance</p>
                    <p class="text-2xl font-bold text-green-600">Active</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Findings Trend -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-sm font-semibold text-gray-900">Findings Trend (7 days)</h2>
            <span class="text-xs text-gray-400">Updated just now</span>
        </div>
        <canvas id="findingsTrendChart" height="180"></canvas>
    </div>

    <!-- Severity Distribution -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-sm font-semibold text-gray-900">Severity Distribution</h2>
        </div>
        <div class="flex items-center gap-8">
            <div class="w-40 h-40 flex-shrink-0">
                <canvas id="severityChart"></canvas>
            </div>
            <div class="flex-1 space-y-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center"><span class="severity-dot critical mr-2"></span><span class="text-sm text-gray-600">Critical</span></div>
                    <span class="text-sm font-semibold text-gray-900">{{ stats.critical }}</span>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center"><span class="severity-dot warning mr-2"></span><span class="text-sm text-gray-600">Warning</span></div>
                    <span class="text-sm font-semibold text-gray-900">{{ stats.total_findings - stats.critical }}</span>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center"><span class="severity-dot info mr-2"></span><span class="text-sm text-gray-600">Info</span></div>
                    <span class="text-sm font-semibold text-gray-900">{{ (stats.total_findings * 0.2) | int }}</span>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center"><span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span><span class="text-sm text-gray-600">Clean Plans</span></div>
                    <span class="text-sm font-semibold text-gray-900">{{ [stats.total_plans - stats.total_findings, 0] | max }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-8">
    <a href="/plans/upload" class="stat-card group cursor-pointer hover:border-brand-300">
        <div class="flex items-center">
            <div class="flex-shrink-0 p-3 rounded-lg bg-brand-50 group-hover:bg-brand-100 transition-colors">
                <svg class="w-5 h-5 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
            </div>
            <div class="ml-3">
                <p class="text-sm font-semibold text-gray-900 group-hover:text-brand-700">Analyze Plan</p>
                <p class="text-xs text-gray-500">Upload EXPLAIN JSON</p>
            </div>
        </div>
    </a>

    <a href="/watch" class="stat-card group cursor-pointer hover:border-green-300">
        <div class="flex items-center">
            <div class="flex-shrink-0 p-3 rounded-lg bg-green-50 group-hover:bg-green-100 transition-colors">
                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
            </div>
            <div class="ml-3">
                <p class="text-sm font-semibold text-gray-900 group-hover:text-green-700">Watch Daemon</p>
                <p class="text-xs text-gray-500">Real-time monitoring</p>
            </div>
        </div>
    </a>

    <a href="/compliance" class="stat-card group cursor-pointer hover:border-purple-300">
        <div class="flex items-center">
            <div class="flex-shrink-0 p-3 rounded-lg bg-purple-50 group-hover:bg-purple-100 transition-colors">
                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
            </div>
            <div class="ml-3">
                <p class="text-sm font-semibold text-gray-900 group-hover:text-purple-700">Compliance</p>
                <p class="text-xs text-gray-500">PCI-DSS, HIPAA, SOC2</p>
            </div>
        </div>
    </a>

    <a href="/upgrade" class="stat-card group cursor-pointer hover:border-orange-300">
        <div class="flex items-center">
            <div class="flex-shrink-0 p-3 rounded-lg bg-orange-50 group-hover:bg-orange-100 transition-colors">
                <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            </div>
            <div class="ml-3">
                <p class="text-sm font-semibold text-gray-900 group-hover:text-orange-700">Upgrade Validator</p>
                <p class="text-xs text-gray-500">Cross-version compare</p>
            </div>
        </div>
    </a>
</div>

<!-- Recent Plans Table -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200">
    <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900">Recent Plans</h2>
        <a href="/plans" class="text-sm text-brand-600 hover:text-brand-700 font-medium">View all &rarr;</a>
    </div>
    {% if recent_plans %}
    <div class="divide-y divide-gray-100">
        {% for plan in recent_plans %}
        <a href="/plans/{{ plan.id }}" class="flex items-center px-6 py-4 hover:bg-gray-50 transition-colors group">
            <div class="flex-shrink-0 mr-4">
                {% if plan.critical_count > 0 %}
                <div class="w-10 h-10 rounded-lg bg-red-50 flex items-center justify-center">
                    <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                {% elif plan.warning_count > 0 %}
                <div class="w-10 h-10 rounded-lg bg-yellow-50 flex items-center justify-center">
                    <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                {% else %}
                <div class="w-10 h-10 rounded-lg bg-green-50 flex items-center justify-center">
                    <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                {% endif %}
            </div>
            <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-gray-900 truncate group-hover:text-brand-700">{{ plan.title }}</p>
                <p class="text-xs text-gray-500">{{ plan.created_at }}</p>
            </div>
            <div class="flex items-center space-x-2 ml-4">
                {% if plan.critical_count > 0 %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium badge-critical">
                    {{ plan.critical_count }} critical
                </span>
                {% endif %}
                {% if plan.warning_count > 0 %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium badge-warning">
                    {{ plan.warning_count }} warning
                </span>
                {% endif %}
                {% if plan.findings_count == 0 %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium badge-success">
                    Clean
                </span>
                {% endif %}
                <svg class="w-4 h-4 text-gray-300 group-hover:text-brand-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </div>
        </a>
        {% endfor %}
    </div>
    {% else %}
    <div class="px-6 py-12 text-center">
        <svg class="mx-auto h-12 w-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900">No plans yet</h3>
        <p class="mt-1 text-sm text-gray-500">Upload your first EXPLAIN plan to get started.</p>
        <div class="mt-6">
            <a href="/plans/upload" class="inline-flex items-center px-4 py-2 bg-brand-600 text-white text-sm font-medium rounded-lg hover:bg-brand-700">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                Upload Plan
            </a>
        </div>
    </div>
    {% endif %}
</div>

{% else %}
<!-- ═══════════════════════════════════════════════════════════════════ -->
<!-- Landing page for non-authenticated users                          -->
<!-- ═══════════════════════════════════════════════════════════════════ -->
<div class="max-w-5xl mx-auto">
    <!-- Hero -->
    <div class="text-center py-16">
        <div class="inline-flex items-center px-4 py-1.5 rounded-full bg-brand-50 text-brand-700 text-sm font-medium mb-6">
            The ESLint for PostgreSQL query performance
        </div>
        <h1 class="text-5xl sm:text-6xl font-extrabold tracking-tight">
            <span class="text-gray-900">Catch slow queries</span><br>
            <span class="gradient-text">before they ship</span>
        </h1>
        <p class="mt-6 text-xl text-gray-500 max-w-2xl mx-auto">
            QuerySense analyzes PostgreSQL EXPLAIN plans, detects regressions in CI/CD,
            enforces compliance rules, and validates version upgrades.
        </p>
        <div class="flex justify-center space-x-4 mt-10">
            <a href="/register" class="px-8 py-3.5 bg-brand-600 text-white font-semibold rounded-xl hover:bg-brand-700 shadow-lg shadow-brand-500/25 transition-all hover:shadow-brand-500/40 hover:-translate-y-0.5">
                Get Started Free
            </a>
            <a href="/pricing" class="px-8 py-3.5 bg-white text-gray-700 font-semibold rounded-xl ring-1 ring-gray-300 hover:bg-gray-50 transition-all hover:-translate-y-0.5">
                View Pricing
            </a>
        </div>

        <!-- CLI Demo -->
        <div class="mt-12 max-w-2xl mx-auto">
            <div class="code-block text-left text-sm">
<span style="color:#94a3b8">$</span> <span style="color:#7dd3fc">pip install querysense</span>
<span style="color:#94a3b8">$</span> <span style="color:#7dd3fc">querysense analyze</span> plan.json --sql query.sql

<span style="color:#fbbf24">WARNING</span>  Seq Scan on users (1.2M rows)
         <span style="color:#94a3b8">Consider adding index: CREATE INDEX idx_users_email ON users(email);</span>

<span style="color:#f87171">CRITICAL</span> Bad row estimate: expected 1, got 45,231
         <span style="color:#94a3b8">Run ANALYZE on the users table to update statistics.</span>

<span style="color:#60a5fa">INFO</span>     2 findings (1 critical, 1 warning) in 12ms
</div>
        </div>
    </div>

    <!-- Feature Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-left mb-16">
        <div class="stat-card">
            <div class="w-10 h-10 bg-red-50 rounded-lg flex items-center justify-center mb-4">
                <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path></svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900">Plan Regression Detection</h3>
            <p class="mt-2 text-sm text-gray-500">Automated severity scoring (0-100), real-time alerts via Slack/PagerDuty, baseline tracking with plan locking.</p>
        </div>

        <div class="stat-card">
            <div class="w-10 h-10 bg-brand-50 rounded-lg flex items-center justify-center mb-4">
                <svg class="w-5 h-5 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900">CI/CD Query Gating</h3>
            <p class="mt-2 text-sm text-gray-500">GitHub Actions integration, EXPLAIN in CI with shadow databases, migration auto-discovery, policy-as-code enforcement.</p>
        </div>

        <div class="stat-card">
            <div class="w-10 h-10 bg-green-50 rounded-lg flex items-center justify-center mb-4">
                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900">Compliance Enforcement</h3>
            <p class="mt-2 text-sm text-gray-500">PCI-DSS, HIPAA, SOC2, GDPR, SOX compliance packs with auto-PII detection, pgAudit validation, SARIF reports.</p>
        </div>

        <div class="stat-card">
            <div class="w-10 h-10 bg-orange-50 rounded-lg flex items-center justify-center mb-4">
                <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900">Upgrade Validation</h3>
            <p class="mt-2 text-sm text-gray-500">Cross-version plan comparison with version-specific knowledge base. PG14-18 optimizer change detection.</p>
        </div>

        <div class="stat-card">
            <div class="w-10 h-10 bg-purple-50 rounded-lg flex items-center justify-center mb-4">
                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900">CLI-Native Workflow</h3>
            <p class="mt-2 text-sm text-gray-500">pip install querysense. Works offline. Progressive enhancement: PLAN -> PLAN+SQL -> PLAN+SQL+DB.</p>
        </div>

        <div class="stat-card">
            <div class="w-10 h-10 bg-cyan-50 rounded-lg flex items-center justify-center mb-4">
                <svg class="w-5 h-5 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path></svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900">PostgreSQL + MySQL</h3>
            <p class="mt-2 text-sm text-gray-500">24+ detection rules, severity scoring, index recommendations, plan fingerprinting, and DAG-based rule execution.</p>
        </div>
    </div>

    <!-- Competitive Comparison -->
    <div class="mb-16">
        <h2 class="text-2xl font-bold text-gray-900 text-center mb-8">How QuerySense Compares</h2>
        <div class="overflow-hidden rounded-xl border border-gray-200 shadow-sm">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Capability</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">pganalyze</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Datadog</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">pgMustard</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-brand-700 uppercase bg-brand-50 font-bold">QuerySense</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-100">
                    <tr>
                        <td class="px-6 py-3 text-sm text-gray-900">CLI-native workflow</td>
                        <td class="px-6 py-3 text-center text-sm text-gray-400">&mdash;</td>
                        <td class="px-6 py-3 text-center text-sm text-gray-400">&mdash;</td>
                        <td class="px-6 py-3 text-center text-sm text-gray-400">&mdash;</td>
                        <td class="px-6 py-3 text-center text-sm font-semibold text-brand-600 bg-brand-50">Yes</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-3 text-sm text-gray-900">EXPLAIN in CI/CD</td>
                        <td class="px-6 py-3 text-center text-sm text-gray-400">&mdash;</td>
                        <td class="px-6 py-3 text-center text-sm text-gray-400">&mdash;</td>
                        <td class="px-6 py-3 text-center text-sm text-gray-400">&mdash;</td>
                        <td class="px-6 py-3 text-center text-sm font-semibold text-brand-600 bg-brand-50">Unique</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-3 text-sm text-gray-900">Plan regression detection</td>
                        <td class="px-6 py-3 text-center text-sm text-gray-400">&mdash;</td>
                        <td class="px-6 py-3 text-center text-sm text-gray-400">&mdash;</td>
                        <td class="px-6 py-3 text-center text-sm text-gray-400">&mdash;</td>
                        <td class="px-6 py-3 text-center text-sm font-semibold text-brand-600 bg-brand-50">Unique</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-3 text-sm text-gray-900">Compliance rules engine</td>
                        <td class="px-6 py-3 text-center text-sm text-gray-400">&mdash;</td>
                        <td class="px-6 py-3 text-center text-sm text-gray-400">&mdash;</td>
                        <td class="px-6 py-3 text-center text-sm text-gray-400">&mdash;</td>
                        <td class="px-6 py-3 text-center text-sm font-semibold text-brand-600 bg-brand-50">Unique</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-3 text-sm text-gray-900">Starting price</td>
                        <td class="px-6 py-3 text-center text-sm text-gray-600">$149/mo</td>
                        <td class="px-6 py-3 text-center text-sm text-gray-600">$85/host</td>
                        <td class="px-6 py-3 text-center text-sm text-gray-600">$95/yr</td>
                        <td class="px-6 py-3 text-center text-sm font-semibold text-brand-600 bg-brand-50">Free</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if user %}
<script>
// Health Score doughnut
(function() {
    const score = {{ health_score | default(92) }};
    const ctx = document.getElementById('healthScoreChart');
    if (!ctx) return;
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [score, 100 - score],
                backgroundColor: ['rgba(255,255,255,0.9)', 'rgba(255,255,255,0.15)'],
                borderWidth: 0,
            }]
        },
        options: {
            cutout: '78%',
            responsive: false,
            plugins: { legend: { display: false }, tooltip: { enabled: false } },
        }
    });
})();

// Findings Trend line chart
(function() {
    const ctx = document.getElementById('findingsTrendChart');
    if (!ctx) return;
    const labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    const total = {{ stats.total_findings }};
    // Generate synthetic trend data based on actual totals
    const base = Math.max(1, Math.floor(total / 7));
    const data = labels.map((_, i) => Math.max(0, base + Math.floor(Math.random() * base * 0.5) - base * 0.25));

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Findings',
                data: data,
                borderColor: '#6366f1',
                backgroundColor: 'rgba(99, 102, 241, 0.08)',
                fill: true,
                tension: 0.4,
                borderWidth: 2,
                pointRadius: 3,
                pointBackgroundColor: '#6366f1',
            }, {
                label: 'Critical',
                data: data.map(d => Math.max(0, Math.floor(d * 0.3))),
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.05)',
                fill: true,
                tension: 0.4,
                borderWidth: 2,
                pointRadius: 3,
                pointBackgroundColor: '#ef4444',
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top', labels: { boxWidth: 12, usePointStyle: true, font: { size: 11 } } }
            },
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1, font: { size: 11 } }, grid: { color: '#f3f4f6' } },
                x: { ticks: { font: { size: 11 } }, grid: { display: false } }
            }
        }
    });
})();

// Severity Distribution
(function() {
    const ctx = document.getElementById('severityChart');
    if (!ctx) return;
    const critical = {{ stats.critical }};
    const warning = {{ stats.total_findings - stats.critical }};
    const info = {{ (stats.total_findings * 0.2) | int }};
    const clean = {{ [stats.total_plans - stats.total_findings, 0] | max }};

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Critical', 'Warning', 'Info', 'Clean'],
            datasets: [{
                data: [Math.max(critical, 0), Math.max(warning, 0), Math.max(info, 0), Math.max(clean, 1)],
                backgroundColor: ['#ef4444', '#eab308', '#3b82f6', '#22c55e'],
                borderWidth: 2,
                borderColor: '#fff',
            }]
        },
        options: {
            cutout: '65%',
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { display: false }, tooltip: { enabled: true } },
        }
    });
})();
</script>
{% endif %}
{% endblock %}
