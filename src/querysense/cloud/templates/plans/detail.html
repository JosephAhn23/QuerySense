{% extends "base.html" %}
{% block title %}{{ plan.title if plan else 'Plan Not Found' }} - QuerySense Cloud{% endblock %}

{% block content %}
{% if error and not plan %}
<div class="rounded-md bg-red-50 p-4">
    <p class="text-sm text-red-700">{{ error }}</p>
</div>
{% elif plan %}

<!-- Header -->
<div class="sm:flex sm:items-center sm:justify-between mb-6">
    <div>
        <div class="flex items-center gap-2 mb-1">
            <a href="/plans" class="text-sm text-gray-400 hover:text-gray-600">&larr; Plans</a>
        </div>
        <h1 class="text-2xl font-bold text-gray-900">{{ plan.title }}</h1>
        <p class="mt-1 text-sm text-gray-500">
            Uploaded {{ plan.created_at }}
            {% for tag in plan.tags %}
            <span class="ml-2 inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-600">{{ tag }}</span>
            {% endfor %}
        </p>
    </div>
    <div class="mt-4 sm:mt-0 flex gap-2">
        <a href="/plans/{{ plan.id }}/compare"
           class="inline-flex items-center rounded-lg bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
            <svg class="w-4 h-4 mr-1.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
            Compare
        </a>
        <form action="/plans/{{ plan.id }}/share" method="POST" class="inline">
            <button type="submit"
                    class="inline-flex items-center rounded-lg bg-brand-600 px-3 py-2 text-sm font-medium text-white shadow-sm hover:bg-brand-700">
                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                Share
            </button>
        </form>
    </div>
</div>

<!-- Share Links -->
{% if share_links %}
<div class="mb-6 rounded-lg bg-blue-50 border border-blue-200 p-4">
    <h3 class="text-sm font-medium text-blue-800 mb-2">Share Links</h3>
    {% for sl in share_links %}
    <div class="flex items-center gap-2 mb-1">
        <input type="text" value="{{ request.base_url }}share/{{ sl.token }}" readonly
               class="flex-1 rounded-md border border-blue-200 bg-white px-2 py-1 text-xs text-gray-700 font-mono"
               onclick="this.select()">
        <button onclick="copyToClipboard('{{ request.base_url }}share/{{ sl.token }}', this)" class="p-1 text-blue-600 hover:text-blue-800">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
        </button>
        <span class="text-xs text-blue-600">Expires: {{ sl.expires_at }}</span>
    </div>
    {% endfor %}
</div>
{% endif %}

{% if analysis %}
<!-- Summary Cards -->
<div class="grid grid-cols-2 gap-4 sm:grid-cols-4 mb-6">
    <div class="stat-card">
        <div class="flex items-center justify-between">
            <dt class="text-sm font-medium text-gray-500">Evidence Level</dt>
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                {% if analysis.evidence_level == 'measured' %}bg-green-100 text-green-800
                {% elif analysis.evidence_level == 'informed' %}bg-blue-100 text-blue-800
                {% else %}bg-gray-100 text-gray-800{% endif %}">
                {{ analysis.evidence_level }}
            </span>
        </div>
    </div>
    <div class="stat-card">
        <dt class="text-sm font-medium text-gray-500">Total Findings</dt>
        <dd class="mt-1 text-2xl font-bold text-gray-900">{{ analysis.summary.total }}</dd>
    </div>
    <div class="stat-card">
        <dt class="text-sm font-medium text-gray-500">Critical</dt>
        <dd class="mt-1 text-2xl font-bold text-red-600">{{ analysis.summary.critical }}</dd>
    </div>
    <div class="stat-card">
        <dt class="text-sm font-medium text-gray-500">Warnings</dt>
        <dd class="mt-1 text-2xl font-bold text-amber-600">{{ analysis.summary.warning }}</dd>
    </div>
</div>

<!-- Tabs: Findings / Plan Tree / SQL / Rule Details -->
<div id="planTabs" class="mb-8">
    <div class="border-b border-gray-200 flex gap-1 mb-6">
        <button class="tab-btn active" data-tab="tab-findings">
            Findings
            {% if analysis.summary.total > 0 %}
            <span class="ml-1.5 inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700">{{ analysis.summary.total }}</span>
            {% endif %}
        </button>
        <button class="tab-btn" data-tab="tab-plantree">Plan Tree</button>
        {% if plan.sql_text %}<button class="tab-btn" data-tab="tab-sql">SQL Query</button>{% endif %}
        {% if analysis.rule_runs %}<button class="tab-btn" data-tab="tab-rules">Rule Details ({{ analysis.rule_runs | length }})</button>{% endif %}
    </div>

    <!-- Findings Tab -->
    <div id="tab-findings" class="tab-content active">
        {% if analysis.findings %}
        <div class="space-y-4">
            {% for finding in analysis.findings %}
            <div class="bg-white shadow-sm rounded-xl overflow-hidden border border-gray-200">
                <div class="px-5 py-4 border-l-4
                    {% if finding.severity == 'critical' %}border-red-500 bg-red-50/50{% elif finding.severity == 'warning' %}border-amber-500 bg-amber-50/50{% else %}border-blue-500 bg-blue-50/50{% endif %}">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-semibold text-gray-900 flex items-center">
                            {% if finding.severity == 'critical' %}
                            <span class="badge-critical inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-bold mr-2">CRITICAL</span>
                            {% elif finding.severity == 'warning' %}
                            <span class="badge-warning inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-bold mr-2">WARNING</span>
                            {% else %}
                            <span class="badge-info inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-bold mr-2">INFO</span>
                            {% endif %}
                            {{ finding.title }}
                        </h3>
                        {% if finding.impact_band and finding.impact_band != 'UNKNOWN' %}
                        <span class="text-xs font-medium px-2 py-0.5 rounded bg-gray-100 text-gray-600">Impact: {{ finding.impact_band }}</span>
                        {% endif %}
                    </div>
                    <p class="mt-1 text-xs text-gray-500">
                        Rule: <code class="bg-white/50 px-1.5 py-0.5 rounded font-mono">{{ finding.rule_id }}</code>
                        &middot; Location: <code class="bg-white/50 px-1.5 py-0.5 rounded font-mono">{{ finding.context.path }}</code>
                        {% if finding.context.relation_name %}
                        &middot; Table: <code class="bg-white/50 px-1.5 py-0.5 rounded font-mono">{{ finding.context.relation_name }}</code>
                        {% endif %}
                    </p>
                </div>
                <div class="px-5 py-4">
                    <p class="text-sm text-gray-700">{{ finding.description }}</p>

                    {% if finding.suggestion %}
                    <div class="mt-4">
                        <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Suggestion</h4>
                        <div class="code-block text-sm relative group">{{ finding.suggestion }}
<button onclick="copyToClipboard(this.parentElement.innerText.trim(), this)" class="absolute top-2 right-2 p-1 rounded bg-gray-700 hover:bg-gray-600 opacity-0 group-hover:opacity-100 transition-opacity"><svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></button></div>
                    </div>
                    {% endif %}

                    {% if finding.assumptions %}
                    <div class="mt-4">
                        <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Assumptions</h4>
                        <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                            {% for assumption in finding.assumptions %}
                            <li>{{ assumption }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if finding.verification_steps %}
                    <div class="mt-4">
                        <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Verification Steps</h4>
                        <ul class="text-sm text-gray-600 space-y-1.5">
                            {% for step in finding.verification_steps %}
                            <li class="flex items-start">
                                <input type="checkbox" class="mt-0.5 mr-2 rounded border-gray-300 text-brand-600">
                                <span>{{ step }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="rounded-xl bg-green-50 border border-green-200 p-8 text-center">
            <svg class="mx-auto h-10 w-10 text-green-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            </svg>
            <h3 class="mt-3 text-sm font-semibold text-green-800">No issues found</h3>
            <p class="mt-1 text-sm text-green-600">This query plan looks healthy.</p>
        </div>
        {% endif %}
    </div>

    <!-- Plan Tree Tab -->
    <div id="tab-plantree" class="tab-content">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-semibold text-gray-900">Visual Plan Tree</h3>
                <span class="text-xs text-gray-400">Interactive visualization of the query execution plan</span>
            </div>
            <div id="planTreeContainer" class="overflow-x-auto">
                <!-- Rendered by JS from plan_json -->
            </div>
        </div>
    </div>

    <!-- SQL Tab -->
    {% if plan.sql_text %}
    <div id="tab-sql" class="tab-content">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="px-5 py-3 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-sm font-semibold text-gray-900">SQL Query</h3>
                <button onclick="copyToClipboard(document.getElementById('sqlContent').innerText, this)" class="inline-flex items-center px-2 py-1 text-xs font-medium text-gray-500 bg-gray-100 rounded hover:bg-gray-200">
                    <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    Copy
                </button>
            </div>
            <div class="p-5">
                <pre class="code-block text-sm" id="sqlContent">{{ plan.sql_text }}</pre>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Rule Details Tab -->
    {% if analysis.rule_runs %}
    <div id="tab-rules" class="tab-content">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rule</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Runtime</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Findings</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for run in analysis.rule_runs %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-xs font-mono text-gray-700">{{ run.rule_id }}</td>
                        <td class="px-4 py-3 text-xs">
                            {% if run.status == 'pass' %}
                            <span class="badge-success inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium">pass</span>
                            {% elif run.status == 'skip' %}
                            <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-600">skip</span>
                            {% else %}
                            <span class="badge-critical inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium">fail</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-xs text-gray-500">{{ "%.1f" | format(run.runtime_ms) }}ms</td>
                        <td class="px-4 py-3 text-xs text-gray-500">{{ run.findings_count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

{% else %}
<div class="text-center py-12 bg-white rounded-xl shadow-sm border border-gray-200">
    <p class="text-sm text-gray-500">No analysis available for this plan.</p>
</div>
{% endif %}

{% endif %}
{% endblock %}

{% block scripts %}
{% if plan and analysis %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    initTabs('planTabs');

    // Parse and render plan tree
    try {
        const planJson = {{ plan.plan_json | safe }};
        const planData = Array.isArray(planJson) ? planJson[0] : planJson;
        const root = planData.Plan || planData;
        const container = document.getElementById('planTreeContainer');
        if (container && root) {
            container.innerHTML = renderPlanNode(root, true);
        }
    } catch(e) {
        const container = document.getElementById('planTreeContainer');
        if (container) {
            container.innerHTML = '<p class="text-sm text-gray-500">Unable to render plan tree. The plan JSON may be in an unsupported format.</p>';
        }
    }
});

function getNodeBadgeClass(nodeType) {
    const nt = (nodeType || '').toLowerCase();
    if (nt.includes('seq scan')) return 'seq-scan';
    if (nt.includes('index')) return 'index-scan';
    if (nt.includes('hash')) return 'hash-join';
    if (nt.includes('nested')) return 'nested-loop';
    if (nt.includes('sort') || nt.includes('merge')) return 'sort';
    return 'default';
}

function formatNumber(n) {
    if (n == null) return '-';
    if (n >= 1000000) return (n/1000000).toFixed(1) + 'M';
    if (n >= 1000) return (n/1000).toFixed(1) + 'K';
    return n.toString();
}

function renderPlanNode(node, isRoot) {
    const nodeType = node['Node Type'] || 'Unknown';
    const badgeClass = getNodeBadgeClass(nodeType);
    const relation = node['Relation Name'] || node['Index Name'] || '';
    const rows = node['Actual Rows'] != null ? node['Actual Rows'] : node['Plan Rows'];
    const cost = node['Total Cost'] != null ? node['Total Cost'] : null;
    const time = node['Actual Total Time'] != null ? node['Actual Total Time'] : null;
    const loops = node['Actual Loops'] || 1;
    const planRows = node['Plan Rows'];
    const actualRows = node['Actual Rows'];

    // Row estimate accuracy
    let estimateWarning = '';
    if (planRows != null && actualRows != null && planRows > 0) {
        const ratio = actualRows / planRows;
        if (ratio > 10 || ratio < 0.1) {
            estimateWarning = '<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-red-100 text-red-700 ml-2">est off ' + (ratio > 1 ? ratio.toFixed(0) + 'x' : (1/ratio).toFixed(0) + 'x under') + '</span>';
        }
    }

    let html = '<div class="plan-node ' + (isRoot ? 'plan-node-root' : '') + ' py-2">';
    html += '<div class="flex items-start gap-2 py-1.5 px-3 rounded-lg hover:bg-gray-50 transition-colors group">';
    html += '<span class="plan-node-badge ' + badgeClass + '">' + nodeType + '</span>';

    if (relation) {
        html += '<span class="text-xs text-gray-500 font-mono">' + relation + '</span>';
    }

    html += estimateWarning;

    html += '<div class="ml-auto flex items-center gap-4 text-xs text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity">';
    if (rows != null) html += '<span>Rows: <strong class="text-gray-600">' + formatNumber(rows) + '</strong></span>';
    if (cost != null) html += '<span>Cost: <strong class="text-gray-600">' + cost.toFixed(1) + '</strong></span>';
    if (time != null) html += '<span>Time: <strong class="text-gray-600">' + time.toFixed(2) + 'ms</strong></span>';
    if (loops > 1) html += '<span>Loops: <strong class="text-gray-600">' + loops + '</strong></span>';
    html += '</div>';
    html += '</div>';

    // Render children
    const children = node['Plans'] || [];
    for (const child of children) {
        html += renderPlanNode(child, false);
    }

    html += '</div>';
    return html;
}
</script>
{% endif %}
{% endblock %}
